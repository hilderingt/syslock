#!/bin/sh

recover_rootmnt()
{
    mount --move ${1} ${rootmnt} || mount -o move ${1} ${rootmnt}
    if [ $? -ne 0 ]; then
       panic "${progname}: recovery error: failed to recover root filesystem to ${rootmnt}"
    fi
}

case "$1" in
    prereqs)
    	echo ""
    	exit 0
    	;;
esac

. /scripts/functions

progname="lockroot"
nolock_file="/nolock"

nolock=
for param in $(cat /proc/cmdline); do
    case ${param} in
        nolock)
            nolock=true ;;
    esac
done

if [ "x${nolock}" = "xtrue" ]; then
    log_warning_msg "${progname}: disabled, found kernel boot parameter 'nolock'"
    exit 0
fi

if [ -e "${rootmnt}${nolock_file}" ]; then
    log_warning_msg "${progname}: disabled, found file '${rootmnt}${nolock_file}'"
    exit 0
fi

overlay_mount=/mnt/overlay
overlay_base=/.lock
overlay_upper=${overlay_base}/rw
overlay_lower=${overlay_base}/ro
overlay_work=${overlay_base}/.work

[ -d ${overlay_base} ] || mkdir -p ${overlay_base}
if [ ${?} -ne 0 ]; then
    log_failure_msg "${progname}: error 1.1: failed to create '${overlay_base}'"
    exit 0
fi

mount -t tmpfs tmpfs-root ${overlay_base}
if [ ${?} -ne 0 ]; then
    log_failure_msg "${progname}: error 1.2: failed to create tmpfs for root filesystem"
    exit 0
fi

[ -d ${overlay_upper} ] || mkdir -p ${overlay_upper}
if [ ${?} -ne 0 ]; then
    log_failure_msg "${progname}: error 2.1: failed to create '${overlay_upper}'"
    exit 0
fi

[ -d ${overlay_lower} ] || mkdir -p ${overlay_lower}
if [ ${?} -ne 0 ]; then
    log_failure_msg "${progname}: error 2.2: failed to create '${overlay_lower}'"
    exit 0
fi

[ -d ${overlay_work} ] || mkdir -p ${overlay_work}
if [ ${?} -ne 0 ]; then
    log_failure_msg "${progname}: error 2.3: failed to create '${overlay_work}'"
    exit 0
fi

mount --move ${rootmnt} ${overlay_lower} || mount -o move ${rootmnt} ${overlay_lower}
if [ ${?} -ne 0 ]; then
    log_failure_msg "${progname}: error 3: failed to move root filesystem from '${rootmnt}' to '${overlay_lower}'"
    exit 0
fi

[ -d ${overlay_mount} ] || mkdir -p ${overlay_mount}
if [ ${?} -ne 0 ]; then
    log_failure_msg "${progname}: error 4.1: failed to create '${overlay_mount}'"
    recover_rootmnt "${overlay_lower}"
    exit 0
fi

mount -t overlay -o lowerdir=${overlay_lower},upperdir=${overlay_upper},workdir=${overlay_work} overlay-root ${overlay_mount}
if [ ${?} -ne 0 ]; then
    log_failure_msg "${progname}: error 4.2: failed to create overlay for root filesystem"
    recover_rootmnt "${overlay_lower}"
    exit 0
fi

[ -d ${overlay_mount}${overlay_base} ] || mkdir -p ${overlay_mount}${overlay_base}
if [ ${?} -ne 0 ]; then
    log_failure_msg "${progname}: error 5.1: failed to create '${overlay_mount}${overlay_base}'"
    recover_rootmnt "${overlay_lower}"
    exit 0
fi

mount --move ${overlay_base} ${overlay_mount}${overlay_base} || mount -o move ${overlay_base} ${overlay_mount}${overlay_base}
if [ ${?} -ne 0 ]; then
    log_failure_msg "${progname}: error 5.2: failed to move '${overlay_base}' to '${overlay_mount}${overlay_base}'"
    recover_rootmnt "${overlay_lower}"
    exit 0
fi

fstab_system=${overlay_mount}${overlay_lower}/etc/fstab
fstab_overlay=${overlay_mount}/etc/fstab

cat <<EOF >${fstab_overlay}
#
#  modified by lockroot at startup
#
EOF

grep -v '^[[:blank:]]*\(#\|$\)' ${fstab_system} |
while IFS= read -r entry; do
    echo "${entry}" | read -r source target fstype mntopts dump pass

    if [ "x${target}" = "x/" -o "x${fstype}" = "xswap" ]; then
        echo "#${entry}"
        continue
    fi

    if [ "x${fstype}" = "xnone" -o "x${fstype}" = "xignore" -o "x${fstype}" = "xtmpfs" ]
        echo "${entry}"
        continue
	fi

    echo "${mntopts}" | grep -q '\(noauto\|r\?bind\)' && echo "${entry}" && continue

    case "${source}" in
        UUID=*|LABEL=*|/*)
            echo "${source} ${target} lockdev devfs=${fstype},${mntopts} ${dump} ${pass}" ;;
        *)
            echo "${entry}" ;;
    esac
done >${fstab_overlay}

mount --move ${overlay_mount} ${rootmnt} || mount -o move ${overlay_mount} ${rootmnt}
if [ ${?} -ne 0 ]; then
    log_failure_msg "${progname}: error 6: failed to move '${overlay_mount}' to '${rootmnt}'"
    recover_rootmnt "${overlay_mount}${overlay_lower}"
    exit 0
fi

log_success_msg "${progname}: sucessfully set up overlay for root filesystem"

exit 0